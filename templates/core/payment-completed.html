{% extends 'partials/base.html' %}
{% load static %}
{% block content %}

<div class="row justify-content-center pt-lg-4 text-center" style="margin-bottom: 200px; margin-top: 100px;">
    <div class="col-lg-5 col-md-7 col-sm-9">
        <h1 class="display-404 py-lg-3">Payment Completed</h1>
        <h2 class="h3 mb-4">Your order has been successfully placed. Order Id #2358934</h2>
        <p class="fs-md mb-4">
        <a href="#">Contact us</a> if you have any issue or question
        </p>
    </div>
</div>

###########################################3
{# --- Phần gợi ý món ăn --- #}
<div class="container mt-5 mb-5" style="margin-bottom: 200px !important;">  {# Tăng margin-bottom để tránh bị che khuất #}
    <hr> {# Thêm đường kẻ ngăn cách #}
    <h2 class="mt-4">Tiện ích: Tìm món ăn theo nguyên liệu?</h2>
    <p>Nhập các nguyên liệu bạn có (ví dụ: thịt gà, hành tây, cà chua), chúng tôi sẽ gợi ý món ăn phù hợp!</p>

    <div class="mb-3">
        <textarea class="form-control" id="ingredient-input" rows="3" placeholder="Nhập nguyên liệu cách nhau bởi dấu phẩy hoặc viết thành câu..."></textarea>
    </div>

    <button class="btn btn-primary" id="suggest-button">Tìm món ăn</button>

    <hr class="mt-4 mb-4">

    <h3>Gợi ý cho bạn:</h3>
    <div id="recommendation-results" class="row">
        {% comment %} Kết quả gợi ý sẽ được chèn vào đây bằng JavaScript {% endcomment %}
        <div id="loading-indicator" style="display: none;">Đang tìm kiếm...</div>
        <div id="error-message" class="text-danger" style="display: none;"></div>
    </div>
</div>

{% comment %} Đặt đoạn script này ở cuối block content hoặc trong block javascript riêng nếu base.html có {% endcomment %}
<script>
    // Hàm để lấy CSRF token từ cookie (Cần thiết cho Django POST request)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Lấy các element
    const suggestButton = document.getElementById('suggest-button');
    const ingredientInput = document.getElementById('ingredient-input');
    const resultsDiv = document.getElementById('recommendation-results');
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMessageDiv = document.getElementById('error-message');

    // Thêm sự kiện click cho nút
    suggestButton.addEventListener('click', () => {
        const userInput = ingredientInput.value.trim();

        if (!userInput) {
            alert('Vui lòng nhập nguyên liệu bạn có.');
            return;
        }

        // Hiển thị loading, ẩn lỗi cũ và kết quả cũ
        loadingIndicator.style.display = 'block';
        errorMessageDiv.style.display = 'none';
        resultsDiv.innerHTML = ''; // Xóa kết quả cũ
         resultsDiv.appendChild(loadingIndicator); // Đưa loading vào lại

        // Gọi API backend bằng fetch
        const apiUrl = "{% url 'core:suggest_food_api' %}"; // Đảm bảo name='suggest_food_api' đúng trong urls.py

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // Gửi CSRF token
            },
            body: JSON.stringify({
                user_input: userInput,
                top_n: 6 // Yêu cầu top 6 gợi ý (tùy chọn)
            })
        })
        .then(response => {
            if (!response.ok) {
                 return response.json().then(err => {throw new Error(err.error || 'Có lỗi xảy ra từ server.')});
            }
            return response.json();
        })
        .then(data => {
            loadingIndicator.style.display = 'none';

            if (data.suggestions && data.suggestions.length > 0) {
                data.suggestions.forEach(recipe => {
                    const recipeCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <img src="${recipe.image_url}" class="card-img-top" alt="${recipe.title}" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${recipe.title}</h5>
                                    <p class="card-text">${recipe.instructions}</p>
                                    {% comment %} <a href="/recipes/${recipe.id}/" class="btn btn-sm btn-outline-primary">Xem chi tiết</a> {% endcomment %}
                                </div>
                            </div>
                        </div>
                    `;
                    resultsDiv.innerHTML += recipeCard;
                });
            } else {
                 resultsDiv.innerHTML = '<p>Không tìm thấy gợi ý nào phù hợp. Hãy thử với nguyên liệu khác.</p>';
            }
        })
        .catch(error => {
            loadingIndicator.style.display = 'none';
            console.error('Error calling suggestion API:', error);
            errorMessageDiv.textContent = 'Lỗi: ' + error.message;
            errorMessageDiv.style.display = 'block';
            resultsDiv.appendChild(errorMessageDiv); // Hiển thị lỗi trong khu vực kết quả
        });
    });

</script>

{% endblock content %}

